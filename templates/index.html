<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <title>Keyword Stability Report</title>
      <link
         href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.css"
         rel="stylesheet"
         type="text/css"
      />
      <link
         href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css"
         rel="stylesheet"
         type="text/css"
      />
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <style type="text/css">
         #myChart {
            height: 200px; /* or any other height */
         }
      </style>
      
   </head>
   <body>
      <div class="container">
         <h1 class="text-center pb-3 pt-3">Payout Keyword Analysis</h1>
         <div class="dropdown text-right mb-2">
            <select class="dropdown" id="period">
               <option value="3 DAY" selected>Last 3 Days</option>
               <option value="1 WEEK">Last 7 Days</option>
               <option value="0 MONTH">This Month</option>
               <option value="1 DAY">Last Month</option>
               <option value="All">All</option>
            </select>
         </div>
         <canvas id="myChart" width="400" height="150" style="margin-bottom: 16px;"></canvas>
         <table
            id="example"
            class="table table-striped table-bordered"
            style="width: 100%; "
         >
            <thead>
               <tr>
                  <th>ClickID</th>
                  <th>Keyword</th>
                  <th>Sum</th>
                  <th>Relatedlink</th>
                  <th>Timestamp</th>
                  <th>Domain</th>
               </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
               <tr>
                  <th>ClickID</th>
                  <th>Keyword</th>
                  <th>Sum</th>
                  <th>Relatedlink</th>
                  <th>Timestamp</th>
                  <th>Domain</th>
               </tr>
            </tfoot>
         </table>
      </div>

      <script
         src="https://code.jquery.com/jquery-3.7.0.js"
         type="text/Javascript"
      ></script>
      <script
         src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"
         type="text/Javascript"
      ></script>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
      <script
         src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"
         type="text/Javascript"
      ></script>
      <script
         src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
         integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
         crossorigin="anonymous"
      ></script>

      <script type="text/Javascript">

         var dataTable;
         var myChart;
         var selperiod = $("#period").val();

         $(document).ready(function(){
            initialize();
            initEvents();
            reloadChart(selperiod);
            reloadTable(selperiod);
         })

         function initialize(){
            dataTable = new DataTable("#example");
         }

         function initEvents(){
            $(".dropdown-item").click(function() {
               var selectedDuration = $(this).text(); // Get the text of the clicked item
               console.log("Selected Duration: " + selectedDuration); // Just for demonstration
               reloadChart(selectedDuration);
               reloadTable(selectedDuration);
            });
         }

         function reloadChart(duration){
            $.ajax({
               url: '/chart-data',
               type: 'GET',
               dataType: 'json',
               success: function(data) {
                  createChart(data.keywords, data.average_revenues);
                  myChart.update({
                     duration: 800,
                     easing: 'easeOutBounce'
                  });
               }
            });
         }

         function reloadTable(duration){
            $.ajax({
               url: '/report',
               type: 'GET',
               data: { period: duration },
               success: function(data) {
                  console.log(data)
                  dataTable.clear().rows.add(data).draw();
               }
            });
         }

         function createChart(keywords, averageRevenues) {
            var ctx = document.getElementById('myChart').getContext('2d');
            myChart = new Chart(ctx, {
               type: 'bar',
               data: {
                     labels: keywords,
                     datasets: [{
                        label: 'Average Revenue',
                        data: averageRevenues,
                        backgroundColor: 'rgba(0, 123, 255, 0.5)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                     }]
               },
               options: {
                  scales: {
                     y: {
                        beginAtZero: true
                     },
                     x: {
                        ticks: {
                           autoSkip: false,
                           maxRotation: 90,
                           minRotation: 0
                        }
                     }
                  },
                  animation: {
                     duration: 1000 // Animation duration in milliseconds
                  },
                  responsive: true,
               }
            });
         }
      </script>
   </body>
</html>
